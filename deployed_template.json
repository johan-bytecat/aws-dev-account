"AWSTemplateFormatVersion: '2010-09-09'\nDescription: 'DevCloud Application Infrastructure - Kite Server with EFS and Data Storage'\n\nParameters:\n  KeyPairName:\n    Type: AWS::EC2::KeyPair::KeyName\n    Description: 'Name of an existing EC2 KeyPair to enable SSH access'\n  \n  NetworkStackName:\n    Type: String\n    Default: 'devcloud-network'\n    Description: 'Name of the network stack that contains VPC and networking resources'\n    \n  DomainName:\n    Type: String\n    Default: 'devcloud.bytecat.co.za'\n    Description: 'Domain name for the hosted zone'\n  \n  PrivateInstanceIP:\n    Type: String\n    Default: '172.16.2.100'\n    Description: 'Fixed private IP address for Private instance'\n    AllowedPattern: '^172\\.16\\.2\\.[0-9]{1,3}$'\n    ConstraintDescription: 'Must be a valid IP address in the private subnet range (172.16.2.0/24)'\n\n  ApplicationName:\n    Type: String\n    Default: 'kite-server'\n    Description: 'Name of the application (used for resource naming)'\n\nResources:\n  # =============================================================================\n  # S3 STORAGE - Application data bucket\n  # =============================================================================\n\n  # S3 bucket for application data and user files\n  DataBucket:\n    Type: AWS::S3::Bucket\n    Properties:\n      BucketName: !Sub 'devcloud-data-${ApplicationName}-${AWS::AccountId}'\n      PublicAccessBlockConfiguration:\n        BlockPublicAcls: true\n        BlockPublicPolicy: true\n        IgnorePublicAcls: true\n        RestrictPublicBuckets: true\n      VersioningConfiguration:\n        Status: Enabled\n      Tags:\n        - Key: Name\n          Value: !Sub 'DevCloud-Data-${ApplicationName}'\n        - Key: Application\n          Value: !Ref ApplicationName\n\n  # =============================================================================\n  # EFS FILE SYSTEM - Shared application storage\n  # =============================================================================\n\n  # Elastic File System - provides shared persistent storage for application\n  EFSFileSystem:\n    Type: AWS::EFS::FileSystem\n    Properties:\n      Encrypted: true\n      PerformanceMode: generalPurpose\n      ThroughputMode: bursting\n      FileSystemTags:\n        - Key: Name\n          Value: !Sub 'DevCloud-EFS-${ApplicationName}'\n        - Key: Application\n          Value: !Ref ApplicationName\n\n  # EFS mount target - allows private subnet to access the file system\n  EFSMountTarget:\n    Type: AWS::EFS::MountTarget\n    Properties:\n      FileSystemId: !Ref EFSFileSystem\n      SubnetId: \n        Fn::ImportValue: !Sub '${NetworkStackName}-Private-Subnet-ID'\n      SecurityGroups:\n        - Fn::ImportValue: !Sub '${NetworkStackName}-EFS-SG-ID'\n\n  # =============================================================================\n  # IAM ROLES FOR APPLICATION INSTANCE\n  # =============================================================================\n\n  # IAM role for private instances - allows S3 access and private DNS management only\n  PrivateInstanceRole:\n    Type: AWS::IAM::Role\n    Properties:\n      RoleName: !Sub 'DevCloud-${ApplicationName}-Role-${AWS::StackName}'\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: ec2.amazonaws.com\n            Action: sts:AssumeRole\n      ManagedPolicyArns:\n        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore\n      Policies:\n        - PolicyName: !Sub 'DevCloud-${ApplicationName}-S3-Access'\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - s3:GetObject\n                  - s3:PutObject\n                  - s3:DeleteObject\n                  - s3:ListBucket\n                Resource:\n                  - !Sub \n                    - 'arn:aws:s3:::${ScriptsBucketName}/*'\n                    - ScriptsBucketName: \n                        Fn::ImportValue: !Sub '${NetworkStackName}-Scripts-Bucket-Name'\n                  - !Sub \n                    - 'arn:aws:s3:::${ScriptsBucketName}'\n                    - ScriptsBucketName: \n                        Fn::ImportValue: !Sub '${NetworkStackName}-Scripts-Bucket-Name'\n                  - !Sub 'arn:aws:s3:::${DataBucket}/*'\n                  - !Sub 'arn:aws:s3:::${DataBucket}'\n        - PolicyName: !Sub 'DevCloud-${ApplicationName}-Route53-Access'\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - route53:ChangeResourceRecordSets\n                  - route53:GetHostedZone\n                  - route53:ListResourceRecordSets\n                Resource: \n                  - !Sub \n                    - 'arn:aws:route53:::hostedzone/${PrivateHostedZoneId}'\n                    - PrivateHostedZoneId: \n                        Fn::ImportValue: !Sub '${NetworkStackName}-Private-Hosted-Zone-ID'\n              - Effect: Allow\n                Action:\n                  - route53:ListHostedZones\n                Resource: '*'\n        - PolicyName: !Sub 'DevCloud-${ApplicationName}-BedRock-Sonnet4-Access'\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - bedrock:InvokeModel\n                  - bedrock:InvokeModelWithResponseStream\n                Resource: \n                  - arn:aws:bedrock:eu-west-1:886047113001:inference-profile/eu.anthropic.claude-sonnet-4-20250514-v1:0\n                  - arn:aws:bedrock:eu-central-1::foundation-model/anthropic.claude-sonnet-4-20250514-v1:0\n                  - arn:aws:bedrock:eu-north-1::foundation-model/anthropic.claude-sonnet-4-20250514-v1:0\n                  - arn:aws:bedrock:eu-south-1::foundation-model/anthropic.claude-sonnet-4-20250514-v1:0\n                  - arn:aws:bedrock:eu-south-2::foundation-model/anthropic.claude-sonnet-4-20250514-v1:0\n                  - arn:aws:bedrock:eu-west-1::foundation-model/anthropic.claude-sonnet-4-20250514-v1:0\n                  - arn:aws:bedrock:eu-west-3::foundation-model/anthropic.claude-sonnet-4-20250514-v1:0\n\n                  \n\n\n\n        - PolicyName: !Sub 'DevCloud-${ApplicationName}-ECR-Access'\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - ecr:GetAuthorizationToken\n                Resource: '*'\n              - Effect: Allow\n                Action:\n                  - ecr:BatchCheckLayerAvailability\n                  - ecr:GetDownloadUrlForLayer\n                  - ecr:BatchGetImage\n                  - ecr:DescribeRepositories\n                  - ecr:ListImages\n                  - ecr:DescribeImages\n                Resource: !Sub 'arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/bytecat-*'\n\n  # Instance profile for private instances - allows EC2 to assume private instance role\n  PrivateInstanceProfile:\n    Type: AWS::IAM::InstanceProfile\n    Properties:\n      InstanceProfileName: !Sub 'DevCloud-${ApplicationName}-Role-${AWS::StackName}'\n      Roles:\n        - !Ref PrivateInstanceRole\n\n  # =============================================================================\n  # PRIVATE APPLICATION INSTANCE\n  # =============================================================================\n\n  # Private instance - main application server with fixed IP and no direct internet access\n  PrivateInstance:\n    Type: AWS::EC2::Instance\n    Properties:\n      InstanceType: t3.small\n      ImageId: ami-042ad6e600ef0750b  # Amazon Linux 2023 AMI 2023.8.20250721.2 x86_64\n      KeyName: !Ref KeyPairName\n      SubnetId: \n        Fn::ImportValue: !Sub '${NetworkStackName}-Private-Subnet-ID'\n      PrivateIpAddress: !Ref PrivateInstanceIP\n      SecurityGroupIds:\n        - Fn::ImportValue: !Sub '${NetworkStackName}-Private-SG-ID'\n      IamInstanceProfile: !Ref PrivateInstanceProfile\n      BlockDeviceMappings:\n        - DeviceName: /dev/xvda\n          Ebs:\n            VolumeSize: 20\n            VolumeType: gp3\n            DeleteOnTermination: true\n      UserData:\n        Fn::Base64: !Sub\n          - |\n            #!/bin/bash\n            \n            # Set up logging for userdata execution\n            exec > >(tee /var/log/user-data.log) 2>&1\n            \n            echo \"=== DevCloud ${ApplicationName} Instance Initialization Started ===\"\n            echo \"Timestamp: $(date)\"\n\n            # Create directories for scripts and parameters\n            mkdir -p /opt/devcloud/scripts\n            mkdir -p /opt/devcloud/config\n\n            # Save initialization parameters to file for future use\n            cat > /opt/devcloud/config/init-parameters.env << EOF\n            APPLICATION_NAME=${ApplicationName}\n            PRIVATE_HOSTED_ZONE_ID=${PrivateHostedZoneId}\n            DOMAIN_NAME=${DomainName}\n            SCRIPTS_BUCKET=${ScriptsBucket}\n            DATA_BUCKET=${DataBucket}\n            EFS_FILESYSTEM_ID=${EFSFileSystem}\n            VPN_NAT_PRIVATE_IP=${VPNNATPrivateIP}\n            EOF\n            \n            # Get instance metadata using IMDSv2\n            TOKEN=$(curl -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\" -s)\n            INSTANCE_ID=$(curl -H \"X-aws-ec2-metadata-token: $TOKEN\" -s http://169.254.169.254/latest/meta-data/instance-id)\n            AMI_ID=$(curl -H \"X-aws-ec2-metadata-token: $TOKEN\" -s http://169.254.169.254/latest/meta-data/ami-id)\n            INSTANCE_TYPE=$(curl -H \"X-aws-ec2-metadata-token: $TOKEN\" -s http://169.254.169.254/latest/meta-data/instance-type)\n            \n            echo \"Instance ID: $INSTANCE_ID\"\n            echo \"AMI ID: $AMI_ID\"\n            echo \"Instance Type: $INSTANCE_TYPE\"\n            echo \"Application: ${ApplicationName}\"\n            echo \"==========================================================\"\n            \n            # Verify NAT Gateway connectivity before proceeding\n            echo \"Verifying internet connectivity through NAT Gateway...\"\n            VPN_NAT_IP=${VPNNATPrivateIP}\n            echo \"Expected NAT Gateway IP: $VPN_NAT_IP\"\n            \n            # Test connectivity with retries\n            for i in {1..10}; do\n                echo \"Connectivity test attempt $i/10...\"\n                if curl -s --connect-timeout 5 http://169.254.169.254/latest/meta-data/instance-id > /dev/null; then\n                    echo \"??? Basic connectivity confirmed\"\n                    break\n                elif [ $i -eq 10 ]; then\n                    echo \"??? Failed to establish connectivity after 10 attempts\"\n                    exit 1\n                else\n                    echo \"Retrying in 30 seconds...\"\n                    sleep 30\n                fi\n            done\n            \n            # Update system packages\n            echo \"Updating system packages...\"\n            yum update -y\n            \n            # Install EFS utilities\n            echo \"Installing EFS utilities...\"\n            yum install -y amazon-efs-utils\n            \n            # Create EFS mount point\n            echo \"Setting up EFS mount...\"\n            mkdir -p /mnt/efs\n            \n            # Mount EFS filesystem\n            echo \"Mounting EFS filesystem: ${EFSFileSystem}\"\n            mount -t efs -o tls ${EFSFileSystem}:/ /mnt/efs\n            \n            # Add EFS mount to fstab for persistence\n            echo \"${EFSFileSystem}.efs.${AWS::Region}.amazonaws.com:/ /mnt/efs efs tls,_netdev\" >> /etc/fstab\n            \n            # Set proper permissions\n            chown ec2-user:ec2-user /mnt/efs\n            \n            # Download and execute initialization script from S3\n            echo \"Downloading initialization script from S3...\"\n            echo \"Scripts Bucket: ${ScriptsBucket}\"\n            echo \"Data Bucket: ${DataBucket}\"\n            echo \"Private Hosted Zone: ${PrivateHostedZoneId}\"\n            echo \"Domain Name: ${DomainName}\"\n            echo \"EFS File System: ${EFSFileSystem}\"\n            \n            if aws s3 cp s3://${ScriptsBucket}/init/private-instance-init.sh /opt/devcloud/scripts/private-instance-init.sh; then\n                chmod +x /opt/devcloud/scripts/private-instance-init.sh\n                echo \"Executing initialization script...\"\n                if /opt/devcloud/scripts/private-instance-init.sh; then\n                    echo \"??? Private instance initialization completed successfully\"\n                else\n                    echo \"??? Private instance initialization failed with exit code $?\"\n                    exit 1\n                fi\n            else\n                echo \"??? Failed to download private-instance-init.sh from S3\"\n                echo \"Instance will continue without application-specific initialization\"\n            fi\n            \n            echo \"=== DevCloud ${ApplicationName} Instance Initialization Completed ===\"\n            echo \"Timestamp: $(date)\"\n            echo \"Parameters saved to: /opt/devcloud/config/init-parameters.env\"\n            echo \"Scripts stored in: /opt/devcloud/scripts/\"\n            echo \"EFS mounted at: /mnt/efs\"\n            echo \"Log file: /var/log/user-data.log\"\n            echo \"==========================================================\"\n          - ApplicationName: !Ref ApplicationName\n            ScriptsBucket: \n              Fn::ImportValue: !Sub '${NetworkStackName}-Scripts-Bucket-Name'\n            DataBucket: !Ref DataBucket\n            PrivateHostedZoneId: \n              Fn::ImportValue: !Sub '${NetworkStackName}-Private-Hosted-Zone-ID'\n            DomainName: \n              Fn::ImportValue: !Sub '${NetworkStackName}-Domain-Name'\n            EFSFileSystem: !Ref EFSFileSystem\n            VPNNATPrivateIP:\n              Fn::ImportValue: !Sub '${NetworkStackName}-VPN-NAT-Private-IP'\n      Tags:\n        - Key: Name\n          Value: !Sub 'DevCloud-${ApplicationName}'\n        - Key: Application\n          Value: !Ref ApplicationName\n\nOutputs:\n  PrivateInstanceId:\n    Description: Private Instance ID\n    Value: !Ref PrivateInstance\n    Export:\n      Name: !Sub '${AWS::StackName}-Private-Instance-ID'\n\n  PrivateInstancePrivateIP:\n    Description: Private Instance Private IP (Fixed)\n    Value: !GetAtt PrivateInstance.PrivateIp\n    Export:\n      Name: !Sub '${AWS::StackName}-Private-Instance-Private-IP'\n\n  DataBucketName:\n    Description: Application Data S3 Bucket Name\n    Value: !Ref DataBucket\n    Export:\n      Name: !Sub '${AWS::StackName}-Data-Bucket-Name'\n\n  EFSFileSystemId:\n    Description: EFS File System ID\n    Value: !Ref EFSFileSystem\n    Export:\n      Name: !Sub '${AWS::StackName}-EFS-FileSystem-ID'\n\n  ApplicationName:\n    Description: Application Name\n    Value: !Ref ApplicationName\n    Export:\n      Name: !Sub '${AWS::StackName}-Application-Name'\n\n  # Network Configuration Documentation\n  ApplicationNetworkConfiguration:\n    Description: 'Application Network Configuration'\n    Value: !Sub \n      - 'Application: ${ApplicationName} | Instance: ${PrivateInstanceIP} | EFS: ${EFSFileSystem} | Data: ${DataBucket}'\n      - PrivateInstanceIP: !Ref PrivateInstanceIP\n        EFSFileSystem: !Ref EFSFileSystem\n        DataBucket: !Ref DataBucket\n        ApplicationName: !Ref ApplicationName\n    Export:\n      Name: !Sub '${AWS::StackName}-Application-Network-Configuration'\n"
